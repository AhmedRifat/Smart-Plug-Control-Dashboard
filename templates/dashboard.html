{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-title">Device Status</div>
            <div id="deviceStatus" class="stat-value status-offline">OFFLINE</div>
            <div id="statusMessage" class="stat-change">Checking connection...</div>
        </div>
        <!-- Metrics Cards in one line -->
        <div class="metrics-row">
            <div class="metric-card">
                <div class="metric-label">Power</div>
                <div class="metric-value" id="powerValue">0.00</div>
                <div class="metric-unit">Watts</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Voltage</div>
                <div class="metric-value" id="voltageValue">0.0</div>
                <div class="metric-unit">Volts</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Current</div>
                <div class="metric-value" id="currentValue">0.000</div>
                <div class="metric-unit">Amps</div>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <button id="btnTurnOn" class="btn-on">Turn ON</button>
        <button id="btnTurnOff" class="btn-off">Turn OFF</button>
    </div>
    
    <h2>Energy Usage Charts</h2>
    <div class="charts-container">
        <canvas id="powerChart"></canvas>
        <canvas id="voltageChart"></canvas>
        <canvas id="currentChart"></canvas>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    
const powerChart = new Chart(document.getElementById('powerChart').getContext('2d'), {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'Power (W)',
            data: [],
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderWidth: 2,
            tension: 0.1,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true, // Add this to prevent shrinking
        aspectRatio: 2,
        scales: { 
            y: { 
                beginAtZero: true,
                min: 0 // Force y-axis to start at 0
            },
            x: { 
                display: true, 
                title: { 
                    display: true, 
                    text: 'Time' 
                } 
            }
        }
    }
});

const voltageChart = new Chart(document.getElementById('voltageChart').getContext('2d'), {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'Voltage (V)',
            data: [],
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderWidth: 2,
            tension: 0.1,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true, // Add this to prevent shrinking
        aspectRatio: 2,
        scales: { 
            y: { 
                beginAtZero: true,
                min: 0 // Force y-axis to start at 0
            },
            x: { 
                display: true, 
                title: { 
                    display: true, 
                    text: 'Time' 
                } 
            }
        }
    }
});

const currentChart = new Chart(document.getElementById('currentChart').getContext('2d'), {
    type: 'line',
    data: {
        labels: [],
        datasets: [{
            label: 'Current (A)',
            data: [],
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderWidth: 2,
            tension: 0.1,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true, // Add this to prevent shrinking
        aspectRatio: 2,
        scales: { 
            y: { 
                beginAtZero: true,
                min: 0 // Force y-axis to start at 0
            },
            x: { 
                display: true, 
                title: { 
                    display: true, 
                    text: 'Time' 
                } 
            }
        }
    }
});

async function updateData() {
    const res = await fetch('/api/status');
    const data = await res.json();
    const now = new Date().toLocaleTimeString();

    const statusCard = document.getElementById('deviceStatus');
    const statusMessage = document.getElementById('statusMessage');
    const powerValue = document.getElementById('powerValue');
    const voltageValue = document.getElementById('voltageValue');
    const currentValue = document.getElementById('currentValue');

    if (data.connected) {
        if (data.power > 0) {
            statusCard.textContent = "ONLINE";
            statusCard.className = "stat-value status-online";
            statusMessage.textContent = "Device is running";
            statusMessage.style.color = "#4CAF50";
        } else {
            statusCard.textContent = "STANDBY";
            statusCard.className = "stat-value status-standby";
            statusMessage.textContent = "Device is ready";
            statusMessage.style.color = "#FFC107";
        }
        
        powerValue.textContent = data.power.toFixed(2);
        voltageValue.textContent = data.voltage.toFixed(1);
        currentValue.textContent = data.current.toFixed(3);
        
        // Update charts
        powerChart.data.labels.push(now);
        powerChart.data.datasets[0].data.push(data.power);
        
        voltageChart.data.labels.push(now);
        voltageChart.data.datasets[0].data.push(data.voltage);
        
        currentChart.data.labels.push(now);
        currentChart.data.datasets[0].data.push(data.current);
        
        // Limit data points to 50
        if (powerChart.data.labels.length > 50) {
            powerChart.data.labels.shift();
            powerChart.data.datasets[0].data.shift();
            voltageChart.data.labels.shift();
            voltageChart.data.datasets[0].data.shift();
            currentChart.data.labels.shift();
            currentChart.data.datasets[0].data.shift();
        }
        
        powerChart.update();
        voltageChart.update();
        currentChart.update();
    } else {
        statusCard.textContent = "OFFLINE";
        statusCard.className = "stat-value status-offline";
        statusMessage.textContent = "Device not connected";
        statusMessage.style.color = "#F44336";
        powerValue.textContent = "0.00";
        voltageValue.textContent = "0.0";
        currentValue.textContent = "0.000";
    }
}

document.getElementById('btnTurnOn').addEventListener('click', async () => {
    const statusCard = document.getElementById('deviceStatus');
    const statusMessage = document.getElementById('statusMessage');
    
    statusCard.textContent = "CONNECTING";
    statusCard.className = "stat-value status-processing";
    statusMessage.textContent = "Turning device ON...";
    statusMessage.style.color = "#2196F3";
    
    try {
        const res = await fetch('/api/turn_on', { method: 'POST' });
        const data = await res.json();
        updateData(); // Refresh status immediately
    } catch (error) {
        statusCard.textContent = "ERROR";
        statusCard.className = "stat-value status-error";
        statusMessage.textContent = "Failed to turn ON";
        statusMessage.style.color = "#F44336";
    }
});

document.getElementById('btnTurnOff').addEventListener('click', async () => {
    const statusCard = document.getElementById('deviceStatus');
    const statusMessage = document.getElementById('statusMessage');
    
    statusCard.textContent = "CONNECTING";
    statusCard.className = "stat-value status-processing";
    statusMessage.textContent = "Turning device OFF...";
    statusMessage.style.color = "#2196F3";
    
    try {
        const res = await fetch('/api/turn_off', { method: 'POST' });
        const data = await res.json();
        updateData(); // Refresh status immediately
    } catch (error) {
        statusCard.textContent = "ERROR";
        statusCard.className = "stat-value status-error";
        statusMessage.textContent = "Failed to turn OFF";
        statusMessage.style.color = "#F44336";
    }
});

setInterval(updateData, 5000);
updateData();
</script>
{% endblock %}